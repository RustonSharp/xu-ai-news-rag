# xu-ai-news-rag PRD（产品需求文档）

1. 引言（背景、目标用户、产品愿景）

- 背景：信息过载时代，个人与团队需要高效获取、沉淀与复用行业新闻与洞察。现有资讯工具缺少“个性化知识库 + 语义检索 + 本地化可控”的能力。xu-ai-news-rag 旨在以本地可控的 LLM 与向量检索能力，构建从“采集-入库-检索-分析-通知”的一体化闭环。
- 目标用户：
  - 职场知识工作者（产品/运营/投研/媒体）
  - 中小团队/创业团队（需要低成本、可控、安全的内部知识系统）
  - 技术从业者（本地私有化部署爱好者）
- 产品愿景：打造“本地化、可控、可扩展”的新闻知识库系统，让用户以最低门槛进行新闻采集、语义检索与洞察分析，并通过自动化流程提升效率。

2. 用户故事与场景描述

- 采集者：我希望系统每天定时抓取我订阅的 RSS 与网页源，并自动入库，失败能告警。
- 知识库管理员：我需要在登录后查看数据列表，按类型/时间筛选，支持批量删除、编辑标签与来源元数据，并能通过页面上传 PDF/Markdown/Excel 等。
- 分析使用者：我希望在搜索框中用自然语言提问，系统优先基于本地知识库检索并按相似度排序返回；若本地无匹配，可自动联网检索（如百度搜索），并对 Top3 结果进行归纳。
- 订阅者：当有新数据入库或定时报表生成时，我希望收到自定义标题与内容的邮件提示。
- 安全合规负责人：我希望系统遵守网站 robots 规范与最小权限原则，所有密钥不落盘。

3. 产品范围与功能列表（Scope & Features）
   A. 采集与入库

- 定时任务：可配置抓取频率/时间段；来源支持 RSS、网页抓取（遵守 robots）、智能代理工具辅助抓取。
- 数据类型：结构化（Excel/CSV）与非结构化（HTML/PDF/Markdown/TXT）。
- 写入接口：统一 API 入库，自动生成/更新向量索引与元数据。
- 入库通知：入库成功后自动发邮件（模板可配置）。
- 智能代理工具抓取（Agent）：
  - 能力：支持需要 JavaScript 渲染、滚动/分页、点击展开的页面抓取；可注入自定义 Headers/UA/Cookies；支持代理池与节流；严格遵守 robots 与站点条款。
  - 策略：基于规则/提示链完成“源发现 → 链接抽取 → 内容抽取 → 去重 → 归一化”；失败重试（指数退避）、最大重试次数、超时与并发可配置。
  - 配置：每个站点可配置抓取模板（CSS/XPath/正则/自定义脚本）、最大并发、速率限制、运行窗口；黑/白名单域名控制。
  - 输出：统一标准结构 {title, url, published_at, source, content, tags, meta} 入库。
  - 审计与合规：提供详细抓取日志、任务 ID 关联、错误分类与告警，便于排障与合规审查。

B. 知识库管理（登录后）

- 列表与筛选：按类型、时间、来源筛选，分页与排序。
- 批量操作：单条/批量删除；批量编辑标签、来源等元数据。
- 上传入口：页面上传多类型文件，支持拖拽、多文件、进度与失败重试。

C. 语义检索与问答（登录后）

- 本地优先：基于向量检索与重排序，返回 Top-K 并由 LLM 组织答案，附带来源引用。
- 联网兜底：本地未命中时，自动触发联网（如百度搜索），取 Top3 经 LLM 归纳后输出，清晰标注“联网结果”。

D. 分析与报表（登录后）

- 聚类与关键词：针对知识库生成聚类分析，展示关键词 Top10 分布（图表）。
- 导出：报表导出为图片/CSV（后续迭代）。

E. 账户与安全

- 登录/登出：JWT 认证。密码安全存储。
- 角色（MVP 可选）：管理员/成员；操作审计日志（后续迭代）。

4. 产品特定 AI 需求
   4.1 模型需求（功能、性能指标）

- LLM：Ollama 本地部署 qwen2.5:3b（默认），用于答案生成、摘要与归纳。
- 向量嵌入：all-MiniLM-L6-v2（文本向量化，中文表现较优，体量小、速度快）。
- 重排模型：ms-marco-MiniLM-L-6-v2（对 Top-K 候选进行相关性重排，提高精确度）。
- 性能指标（MVP 建议）：

  - 平均检索延迟（端到端）≤ 2s（Top5 返回）；
  - 前 3 条相关性点击/满意度 ≥ 70%；
  - 入库向量化吞吐 ≥ 20 docs/min（视机器性能可调）。

    4.2 数据需求（来源、数量、质量、标注）

- 来源：RSS、目标网站页面、手动上传（Excel/CSV/PDF/MD/TXT）。
- 数量：MVP 目标 1 万文档量级；后续支持增量扩容。
- 质量：抓取遵守 robots；去重、清洗（移除脚本/广告区块）；保留标题、正文、时间、来源、标签。
- 标注：上传可选标签；系统自动生成关键词（用于聚类与分析）。

  4.3 算法边界与可解释性

- 边界：LLM 生成仅供参考，必须附带引用；联网结果需标明来源与时间。
- 可解释性：显示检索到的 Top-K 片段与相似度；显示重排前后差异（高级模式）。

  4.4 评估标准

- 检索质量：人工评测集（10-30 问），MRR@10、nDCG@10 作为观察指标。
- 可用性：任务成功率、用户完成时间、主观满意度（调查问卷）。
- 稳定性：7 天可用性 ≥99%。

  4.5 伦理与合规

- 数据合规：尊重版权与抓取规则，不爬取受限内容；对外展示需标明来源。
- 隐私与安全：不上传敏感数据至第三方；密钥与凭据安全管理（环境变量/密钥库，禁止日志明文）。

  4.6 智能代理工具（Agent）设计

- 架构：基于 LangChain 工具链与提示模板，包含 CrawlerAgent（页面访问/渲染）、Extractor（内容抽取/清洗）、Normalizer（结构化与去重）、Scheduler（计划/并发控制）。
- 触发：按定时计划/手动 API/失败自动重试；每次运行均记录任务与日志。
- 安全：严格遵循 robots.txt；对受限站点不启用；headers/cookies 等凭据通过环境变量注入且不写入日志；限速与并发保护，避免对目标站点造成压力。
- 指标（MVP）：抓取成功率 ≥95%；JS 渲染页面平均渲染耗时 ≤3s（视机器性能）；错误率与重试率在监控面板可观测。

5. 非功能性需求（性能、安全、可用性等）

- 性能
  - 后端 QPS≥30（检索场景，单机中配）；检索端到端 P95≤3s；入库 P95≤10s/文档。
  - 向量库：FAISS（内存/磁盘索引，根据数据量选用），支持批量构建与并行化。
- 安全
  - 身份认证：JWT；密码加盐哈希存储；CORS 最小化放行；速率限制与基础防刷。
  - 抓取合规：遵守 robots；用户配置 UA 与节流；黑白名单机制。
  - 配置安全：密钥通过环境变量；邮件服务 SMTP 配置不落盘。
- 可用性与运维
  - 日志：采集、入库、检索、邮件发送均有结构化日志；
  - 告警：抓取/入库失败与关键任务异常邮件告警；
  - 健康检查：后端/嵌入/LLM/向量库依赖探活接口。

6. 发布标准与衡量指标

- 功能验收
  - 采集：能按计划抓取至少 3 个 RSS 源并入库成功；
  - 入库与通知：结构化与非结构化数据入库成功后触发邮件通知；
  - 管理：列表筛选、批量删除、编辑元数据、上传多类型文件可用；
  - 检索：本地优先，返回 Top5 并含来源引用；
  - 兜底：本地未命中自动联网，取 Top3 并由 LLM 归纳；
  - 分析：展示关键词 Top10 图表。
  - 智能代理抓取：至少完成 1 个需要 JS 渲染/滚动加载站点的稳定抓取并入库；任务日志完整、失败自动重试生效。
- 质量与性能
  - 端到端检索 P95≤3s；
  - 入库成功率 ≥98%；
  - 人工评测 Top3 满意度 ≥70%。
- 安全与合规
  - JWT 登录生效；
  - 密钥与配置不明文；
  - 抓取遵守 robots；
  - 日志不含敏感信息。

7. 架构与技术选型（与实现强相关）

- 前端：React（登录、数据管理、检索问答、报表可视化）。
- 后端：Flask（REST API、任务编排、鉴权、日志与告警）。
- 数据库：SQLite（元数据/用户/任务），FAISS（向量库）。
- 框架：LangChain（RAG 构建、检索与重排、Agent 编排）。
- 模型：Ollama（qwen2.5:3b）、all-MiniLM-L6-v2（Embed）、ms-marco-MiniLM-L-6-v2（Rerank）。

8. 里程碑与范围控制

- 里程碑 M1（2 周）：登录/JWT、上传入库、向量检索（本地优先）与回答、列表管理、邮件通知。
- 里程碑 M2（2 周）：RSS/网页定时采集与合规、联网兜底（百度 Top3）、关键词 Top10 报表。
- 里程碑 M3（迭代）：批量操作优化、审计日志、更多可视化与导出、可插拔搜索引擎与模型切换。

9. 待定项与风险

- 第三方搜索：百度搜索 API 配额与费用、替代方案（后续可插拔）。
- 向量规模扩张：FAISS 索引类型与资源消耗评估；磁盘索引策略。
- 法务合规：页面抓取的范围与权属边界；公开分享策略。
- 多语言与跨域：后续是否支持英文源；CORS 最小放开策略。
- 角色/权限：是否需要更细粒度的 RBAC；多租户需求评估。
- 反爬与代理：部分站点限流/反爬严格，可能需要代理池、动态 UA 与更严格的合规策略，存在成本与不确定性。
